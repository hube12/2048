<html>

<head>
    <title>2048 a big game</title>
    <link rel="stylesheet" type="text/css" href="style.css" /> </head>

<body>
    <div id="grille"></div>
</body>
<script>
    var isMouseDown = false;
    var deltaX, deltaY;

    function generate() {
        var table = document.createElement("table")
        for (i = 0; i < 4; i++) {
            var row = table.insertRow(i)
            for (j = 0; j < 4; j++) {
                var cell = row.insertCell(j)
                cell.classList.add("cell")
                cell.id = i * 4 + j
            }
        }
        table.classList.add("table")
        var div = document.getElementById('grille');
        if (div.hasChildNodes()) //just in case, dynamic website are too harsh
        {
            div.removeChild(div.childNodes[0]);
        }
        div.appendChild(table);
    }

    function randomize() {
        if (Math.random() < 0.9) {
            return 2
        }
        return 4
    }

    function start() {
        dalle = randomize()
        position = Math.floor(Math.random() * 16)
        var el = document.createElement("div")
        el.innerHTML = dalle
        el.classList.add("dalle")
        if (dalle == 2) {
            el.style.background = "#eee4da"
        }
        else {
            el.style.background = "#ede0c8"
        }
        var parent = document.getElementById(position)
        if (parent.hasChildNodes()) {
            return start()
        }
        parent.appendChild(el)
    }

    function appear() {
        //make arrow appear
    }

    function mouseDown(event) {
        isMouseDown = true;
        deltaX = -event.clientX
        deltaY = event.clientY
    }

    function mouseUp(event) {
        deltaX += event.clientX
        deltaY -= event.clientY
        deltaX /= 2
        deltaY /= 2
        if (isMouseDown && (Math.abs(deltaX) > 20 || Math.abs(deltaY) > 20)) {
            if (Math.abs(deltaX) > Math.abs(deltaY)) {
                if (deltaX < 0) {
                    //moove left
                    moove(0, 1)
                }
                else {
                    //moove right
                    moove(1, -1)
                }
            }
            else {
                if (deltaY < 0) {
                    //moove down
                    moove(1, -4)
                }
                else {
                    //moove up
                    moove(0, 4)
                }
            }
        }
        isMouseDown = false;
    }

    

    function color(enfant) {
        switch (Number(enfant.innerHTML)) {
        case 2:
            b = "#eee4da";
            break;
        case 4:
            b = "#ede0c8";
            break;
        case 8:
            b = "#f2b179";
            break;
        case 16:
            b = "#f59563";
            break;
        case 32:
            b = "#F67c5f";
            break;
        case 64:
            b = "#f65e3b";
            break;
        case 128:
            b = "#edcf72";
            break;
        case 256:
            b = "#edcc61";
            break;
        case 512:
            b = "#edc850";
            break;
        case 1024:
            b = "#edc53f";
            break;
        case 2048:
            b = "#edc22e";
            break;
        default:
            b = "#3c3a32"
        }
        enfant.style.background=b
        return enfant
    }

    function moove(pt, dr) {
        var compte = 0
        if (pt == 0) {
            dep = 0
        }
        else {
            dep = 15
        }
        for (p = 0; p < 4; p++) {
            for (v = 0; v < 4; v++) {
                for (i = 0; i < 4; i++) {
                    var current = document.getElementById(dep + (dr * (i + 4 * v)) % 15)
                    if (i != 3) {
                        var next = document.getElementById(dep + (dr * (i + 4 * v)) % 15 + dr)
                        if (next.hasChildNodes()) {
                            nextEnfant = next.firstChild
                            if (current.hasChildNodes()) {
                                var enfant = current.firstChild
                                if (nextEnfant.innerHTML == enfant.innerHTML && nextEnfant.getAttribute("info") == null) {
                                    next.removeChild(nextEnfant)
                                    enfant.innerHTML *= 2
                                    enfant = color(enfant)
                                    enfant.setAttribute("info", "double")
                                    compte += 1
                                }
                            }
                            else {
                                next.removeChild(nextEnfant)
                                current.appendChild(nextEnfant)
                                compte += 1
                            }
                        }
                    }
                    
                }
            }
        }
        var total = document.querySelectorAll(".dalle")
        for (i = 0; i < total.length; i++) {
            total[i].removeAttribute("info")
        }
        if (total.length == 16) {
            console.log("perdu")
            return
        }
        if (compte) {
            start()
        }
    }
    generate()
    start()
    start()
    document.addEventListener("click", appear)
    //document.addEventListener("mousemove", action)
    document.addEventListener("mousedown", mouseDown)
    document.addEventListener("mouseup", mouseUp)
    function action(event) {
        //bad approch
                    if (current.hasChildNodes() && i != 3 && false) {
                        var enfant = current.firstChild
                        var next = document.getElementById(dep + (dr * (i + 4 * v)) % 15 + dr)
                        console.log(next)
                        console.log(enfant, next)
                        if (next.hasChildNodes()) {
                            nextEnfant = next.firstChild
                            if (nextEnfant.innerHTML == enfant.innerHTML && nextEnfant.getAttribute("alt") == null) {
                                current.removeChild(enfant)
                                nextEnfant.innerHTML *= 2
                                nextEnfant.setAttribute("alt", "double")
                            }
                        }
                        else {
                            current.removeChild(enfant)
                            next.appendChild(enfant)
                        }
                        //bulshit fix with p boucle
                        for (y = 0; y < 0; y++) {
                            var prec = document.getElementById(dep + (dr * (i + 4 * v)) % 15 - y * dr)
                            console.log(dep + (dr * (i + 4 * v)) % 15 - y * dr, dep + (dr * (i + 4 * v)) % 15 - (y - 1) * dr)
                            var current = document.getElementById(dep + (dr * (i + 4 * v)) % 15 - (y - 1) * dr)
                            if (prec != null && current != null) {
                                if (prec.hasChildNodes() && !current.hasChildNodes()) {
                                    prec.removeChild(prec.firstChild)
                                    current.appendChild(prec.firstChild)
                                }
                            }
                        }
                        //end of bullshit
                    }
    }
</script>

</html>